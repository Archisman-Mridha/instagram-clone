package graphql_generated

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.42

import (
	"context"

	"golang.org/x/sync/errgroup"

	grpc_generated "github.com/Archisman-Mridha/instagram-clone/backend/gateway/generated/grpc"
	"github.com/Archisman-Mridha/instagram-clone/backend/gateway/utils"
)

func (r *mutationResolver) Signup(ctx context.Context, args SignupArgs) (*AuthenticationOutput, error) {
	ctx, span := r.Tracer.Start(ctx, "Signup")
	defer span.End()

	response, err := r.UsersMicroservice.Signup(ctx, &grpc_generated.SignupRequest{
		Name:     args.Name,
		Email:    args.Email,
		Username: args.Username,
		Password: args.Password,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return &AuthenticationOutput{UserID: int(response.UserId), Jwt: response.Jwt}, nil
}

func (r *mutationResolver) Follow(ctx context.Context, followeeID int) (*bool, error) {
	ctx, span := r.Tracer.Start(ctx, "Follow")
	defer span.End()

	userId, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	if userId == int32(followeeID) {
		return nil, nil
	}

	_, err := r.FollowshipsMicroservice.Follow(ctx, &grpc_generated.FollowshipOperationRequest{
		FollowerId: userId,
		FolloweeId: int32(followeeID),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return nil, nil
}

func (r *mutationResolver) Unfollow(ctx context.Context, followeeID int) (*bool, error) {
	ctx, span := r.Tracer.Start(ctx, "Unfollow")
	defer span.End()

	userId, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	_, err := r.FollowshipsMicroservice.Unfollow(ctx, &grpc_generated.FollowshipOperationRequest{
		FollowerId: userId,
		FolloweeId: int32(followeeID),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return nil, nil
}

func (r *mutationResolver) CreatePost(ctx context.Context, args CreatePostArgs) (int, error) {
	ctx, span := r.Tracer.Start(ctx, "CreatePost")
	defer span.End()

	userId, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return 0, utils.ErrUnauthenticated
	}

	postID, err := r.PostsMicroservice.CreatePost(ctx, &grpc_generated.CreatePostRequest{
		OwnerId: userId,

		Description: args.Description,
	})
	if err != nil {
		span.RecordError(err)
		return 0, err
	}

	return int(postID.PostId), nil
}

func (r *queryResolver) Signin(ctx context.Context, args SigninArgs) (*AuthenticationOutput, error) {
	ctx, span := r.Tracer.Start(ctx, "Signin")
	defer span.End()

	response, err := r.UsersMicroservice.Signin(ctx, &grpc_generated.SigninRequest{
		Identifier: args.Identifier,
		Password:   args.Password,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return &AuthenticationOutput{UserID: int(response.UserId), Jwt: response.Jwt}, nil
}

func (r *queryResolver) SearchProfiles(ctx context.Context, args SearchProfilesArgs) (*SearchProfilesOutput, error) {
	ctx, span := r.Tracer.Start(ctx, "SearchProfiles")
	defer span.End()

	_, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	response, err := r.ProfilesMicroservice.SearchProfiles(ctx, &grpc_generated.SearchProfilesRequest{
		Query: args.Query,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	profilePreviews := ProfilePreviewsToGraphQL(response.ProfilePreviews)
	return &SearchProfilesOutput{ProfilePreviews: profilePreviews}, nil
}

func (r *queryResolver) GetFollowers(ctx context.Context, args GetFollowersArgs) ([]*ProfilePreview, error) {
	ctx, span := r.Tracer.Start(ctx, "GetFollowers")
	defer span.End()

	_, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	getFollowersResponse, err := r.FollowshipsMicroservice.GetFollowers(ctx, &grpc_generated.GetFollowersRequest{
		UserId: int32(args.UserID),

		PageSize: int64(args.PageSize),
		Offset:   int64(args.Offset),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	getProfilePreviewsResponse, err := r.ProfilesMicroservice.GetProfilePreviews(ctx, &grpc_generated.GetProfilePreviewsRequest{
		Ids: getFollowersResponse.FollowerIds,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	profilePreviews := ProfilePreviewsToGraphQL(getProfilePreviewsResponse.ProfilePreviews)
	return profilePreviews, nil
}

func (r *queryResolver) GetFollowings(ctx context.Context, args GetFollowingsArgs) ([]*ProfilePreview, error) {
	ctx, span := r.Tracer.Start(ctx, "GetFollowings")
	defer span.End()

	_, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	getFollowingsResponse, err := r.FollowshipsMicroservice.GetFollowings(ctx, &grpc_generated.GetFollowingsRequest{
		UserId: int32(args.UserID),

		PageSize: int64(args.PageSize),
		Offset:   int64(args.Offset),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	getProfilePreviewsResponse, err := r.ProfilesMicroservice.GetProfilePreviews(ctx, &grpc_generated.GetProfilePreviewsRequest{
		Ids: getFollowingsResponse.FolloweeIds,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	profilePreviews := ProfilePreviewsToGraphQL(getProfilePreviewsResponse.ProfilePreviews)
	return profilePreviews, nil
}

func (r *queryResolver) GetProfile(ctx context.Context, args GetProfileArgs) (*Profile, error) {
	ctx, span := r.Tracer.Start(ctx, "GetProfile")
	defer span.End()

	userId, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	waitGroup, _ := errgroup.WithContext(ctx)

	profile := &Profile{}

	waitGroup.Go(func() error {
		response, err := r.ProfilesMicroservice.GetProfilePreviews(ctx, &grpc_generated.GetProfilePreviewsRequest{
			Ids: []int32{int32(args.UserID)},
		})
		if err != nil {
			return err
		}

		// TODO: Handle error if len(response.ProfilePreviews) != 1

		profilePreview := response.ProfilePreviews[0]

		profile.ID = int(profilePreview.Id)
		profile.Name = profilePreview.Name
		profile.Username = profilePreview.Username

		return nil
	})

	waitGroup.Go(func() error {
		response, err := r.FollowshipsMicroservice.GetFollowshipCounts(ctx, &grpc_generated.GetFollowshipCountsRequest{
			UserId: int32(args.UserID),
		})
		if err != nil {
			return err
		}

		profile.FollowerCount = int(response.FollowerCount)
		profile.FollowingCount = int(response.FollowingCount)

		return nil
	})

	waitGroup.Go(func() error {
		response, err := r.FollowshipsMicroservice.DoesFollowshipExist(ctx, &grpc_generated.DoesFollowshipExistRequest{
			FollowerId: userId,
			FolloweeId: int32(args.UserID),
		})
		if err != nil {
			return err
		}

		profile.IsFollowee = response.Exists

		return nil
	})

	waitGroup.Go(func() error {
		response, err := r.PostsMicroservice.GetPostsOfUser(ctx, &grpc_generated.GetPostsOfUserRequest{
			OwnerId: int32(args.UserID),

			Offset:   0,
			PageSize: int64(args.MaxRecentPostCount),
		})
		if err != nil {
			return err
		}

		profile.RecentPosts = PostsToGraphQL(response.Posts)

		return nil
	})

	err := waitGroup.Wait()
	if err != nil {
		span.RecordError(err)
	}

	return profile, err
}

func (r *queryResolver) GetPostsOfUser(ctx context.Context, args GetPostsOfUserArgs) ([]*Post, error) {
	ctx, span := r.Tracer.Start(ctx, "GetPostsOfUser")
	defer span.End()

	_, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	response, err := r.PostsMicroservice.GetPostsOfUser(ctx, &grpc_generated.GetPostsOfUserRequest{
		OwnerId: int32(args.UserID),

		Offset:   int64(args.Offset),
		PageSize: int64(args.PageSize),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return PostsToGraphQL(response.Posts), nil
}

func (r *queryResolver) GetFeed(ctx context.Context, args GetFeedArgs) ([]*Post, error) {
	ctx, span := r.Tracer.Start(ctx, "GetFeed")
	defer span.End()

	userId, isUserAuthenticated := ctx.Value(utils.USER_ID_CONTEXT_KEY).(int32)
	if !isUserAuthenticated {
		return nil, utils.ErrUnauthenticated
	}

	if args.PageSize == 0 {
		return []*Post{}, nil
	}

	getFeedResponse, err := r.FeedsMicroservice.GetFeed(ctx, &grpc_generated.GetFeedRequest{
		UserId: userId,

		Offset:   int64(args.Offset),
		PageSize: int64(args.PageSize),
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	response, err := r.PostsMicroservice.GetPosts(ctx, &grpc_generated.GetPostsRequest{
		PostIds: getFeedResponse.PostIds,
	})
	if err != nil {
		span.RecordError(err)
		return nil, err
	}

	return PostsToGraphQL(response.Posts), nil
}

func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
